@using Models.Resources
@using System.Text.Json
@using Radzen
@using Radzen.Blazor
@inject ApiClient ApiClient
@inject NavigationManager NavManager
@inject NotificationService NotificationService

<RadzenCard Style="padding:20px">
    <RadzenHeading Size="H4">JSON Schema Builder</RadzenHeading>
    
    <RadzenStack Spacing="20px" Style="margin-top:20px">
        <RadzenTextBox Placeholder="Schema Title" Style="width:100%" @bind-Value="title" />
        
        <RadzenButton Text="Add Section" Icon="add" Click="@AddSection" ButtonStyle="ButtonStyle.Secondary" />
        
        @foreach (var sec in sections)
        {
            <RadzenFieldset Text="@sec.Name" Style="margin-bottom: 20px">
                <HeaderTemplate>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="width: 100%">
                        <RadzenText Text="@sec.Name" TextStyle="TextStyle.Subtitle1" />
                        <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(() => RemoveSection(sec))" />
                    </RadzenStack>
                </HeaderTemplate>
                <ChildContent>
                    <RadzenDataGrid Data="@sec.Properties" TItem="PropertyModel" AllowSorting="false" AllowPaging="false">
                        <Columns>
                            <RadzenDataGridColumn TItem="PropertyModel" Property="Name" Title="Property Name">
                                <Template Context="prop">
                                    <RadzenTextBox @bind-Value="prop.Name" Style="width:100%" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="PropertyModel" Property="Type" Title="Data Type">
                                <Template Context="prop">
                                    <RadzenDropDown Data="@dataTypes" @bind-Value="prop.Type" Style="width:100%" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="PropertyModel" Title="Actions" Width="70px">
                                <Template Context="prop">
                                    <RadzenButton Icon="remove_circle" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(() => sec.Properties.Remove(prop))" />
                                </Template>
                            </RadzenDataGridColumn>
                        </Columns>
                    </RadzenDataGrid>
                    <RadzenButton Text="Add Property" Icon="add" Size="ButtonSize.Small" Click="@(() => sec.Properties.Add(new PropertyModel()))" Style="margin-top: 10px" />
                </ChildContent>
            </RadzenFieldset>
        }
        
        <RadzenButton Text="Save Schema" Icon="save" Click="@SaveSchema" ButtonStyle="ButtonStyle.Primary" Style="margin-top: 20px" />
    </RadzenStack>
</RadzenCard>

@code {
    private string title = "";
    private List<SectionModel> sections = new();
    private List<string> dataTypes = new() { "string", "number", "integer", "boolean", "object", "array" };

    private void AddSection()
    {
        sections.Add(new SectionModel { Name = $"Section {sections.Count + 1}" });
    }

    private void RemoveSection(SectionModel section)
    {
        sections.Remove(section);
    }

    private async Task SaveSchema()
    {
        if (string.IsNullOrWhiteSpace(title))
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Warning, Summary = "Required", Detail = "Please enter a title" });
            return;
        }

        try
        {
            var schemaDict = new Dictionary<string, object>();
            foreach (var section in sections)
            {
                var sectionProps = new Dictionary<string, string>();
                foreach (var prop in section.Properties)
                {
                    if (!string.IsNullOrWhiteSpace(prop.Name))
                    {
                        sectionProps[prop.Name] = prop.Type;
                    }
                }
                schemaDict[section.Name] = sectionProps;
            }

            var jsonResource = new JsonResource
            {
                EntityId = title,
                ResourceKind = "Schema",
                Data = JsonSerializer.SerializeToElement(schemaDict),
                CreatedAt = DateTime.UtcNow,
                OwnerId = "DefaultUser" // TODO: Get from auth
            };

            await ApiClient.Post<JsonResource, JsonResource>($"api/JsonResource/Create/User/{jsonResource.OwnerId}", jsonResource, default);
            
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Success", Detail = "Schema saved successfully" });
            NavManager.NavigateTo("/JsonResources");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"Failed to save schema: {ex.Message}" });
        }
    }

    public class SectionModel
    {
        public string Name { get; set; } = "";
        public List<PropertyModel> Properties { get; set; } = new();
    }

    public class PropertyModel
    {
        public string Name { get; set; } = "";
        public string Type { get; set; } = "string";
    }
}
