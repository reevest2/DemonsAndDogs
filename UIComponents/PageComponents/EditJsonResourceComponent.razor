@using Models.Resources
@using System.Text.Json
@using MediatR
@using Mediator.Mediator.Contracts
@using Radzen
@using Radzen.Blazor
@inject IMediator Mediator
@inject ApiClient ApiClient
@inject NavigationManager NavManager
@inject NotificationService NotificationService

<RadzenCard>
    <RadzenHeading Size="H4">Edit JSON Resource (Schema)</RadzenHeading>
    
    @if (resource == null)
    {
        <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else
    {
        <RadzenTemplateForm Data="@resource" TItem="JsonResource" Submit="@SaveResource">
            <RadzenStack Spacing="20px" Style="margin-top: 20px">
                <RadzenTextBox Name="EntityId" Placeholder="Resource Title" Style="width:100%" @bind-Value="resource.EntityId" />
                <RadzenTextBox Name="ResourceKind" Placeholder="Resource Kind" Style="width:100%" @bind-Value="resource.ResourceKind" />
                
                <RadzenLabel Text="Raw JSON Content" />
                <RadzenTextArea Name="Data" @bind-Value="jsonText" Style="width:100%; height: 400px; font-family: monospace" />
                
                <RadzenStack Orientation="Orientation.Horizontal" Spacing="10px">
                    <RadzenButton Text="Update" Icon="update" ButtonStyle="ButtonStyle.Primary" Type="Submit" />
                    <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Secondary" Click="@(() => NavManager.NavigateTo("/JsonResources"))" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    [Parameter] public string ResourceId { get; set; }
    private JsonResource? resource;
    private string jsonText = "";
    private string ownerId = "DefaultUser"; // TODO: Get from auth

    protected override async Task OnInitializedAsync()
    {
        try
        {
            resource = await Mediator.Send(new GetJsonResourceByIdQuery(ownerId, ResourceId));
            jsonText = JsonSerializer.Serialize(resource.Data, new JsonSerializerOptions { WriteIndented = true });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"Failed to load resource: {ex.Message}" });
        }
    }

    private async Task SaveResource()
    {
        try
        {
            if (resource == null) return;
            
            // Validate and parse JSON
            using var doc = JsonDocument.Parse(jsonText);
            resource.Data = doc.RootElement.Clone();
            resource.UpdatedAt = DateTime.UtcNow;

            await ApiClient.Put($"api/JsonResource/Update/User/{ownerId}/{resource.Id}", resource, default);
            
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Success", Detail = "Resource updated successfully" });
            NavManager.NavigateTo("/JsonResources");
        }
        catch (JsonException jex)
        {
             NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Invalid JSON", Detail = jex.Message });
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = $"Failed to update resource: {ex.Message}" });
        }
    }
}
