@using Models.Resources
@using System.Text.Json
@using MediatR
@using Mediator.Mediator.Contracts
@using Radzen
@using Radzen.Blazor
@inject IMediator Mediator
@inject NavigationManager NavManager
@inject NotificationService NotificationService

<RadzenStack Gap="20px">
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenText Text="@($"Schema Editor: {schema.Name} ({schema.SchemaKey})")" TextStyle="TextStyle.H4" />
        <RadzenStack Orientation="Orientation.Horizontal" Gap="10px">
            <RadzenButton Text="Save Draft" Icon="save" Click="@SaveDraft" />
            <RadzenButton Text="Validate" Icon="check_circle" Click="@ValidateDraft" ButtonStyle="ButtonStyle.Secondary" />
            <RadzenButton Text="Publish" Icon="publish" Click="@PublishDraft" ButtonStyle="ButtonStyle.Success" 
                          Disabled="@(!isValidated)" />
        </RadzenStack>
    </RadzenStack>

    <RadzenCard>
        <RadzenText Text="Draft JSON (Text Editor)" TextStyle="TextStyle.Subtitle2" />
        <RadzenTextArea @bind-Value="draftJsonText" Style="width:100%; height: 500px; font-family: monospace" />
    </RadzenCard>

    @if (validationResult != null)
    {
        <RadzenCard>
            <RadzenText Text="Validation Results" TextStyle="TextStyle.Subtitle2" />
            @if (validationResult.IsValid)
            {
                <RadzenAlert AlertStyle="AlertStyle.Success">Draft is valid and supports MVP features.</RadzenAlert>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Danger">
                    <ul style="margin: 0">
                        @foreach (var error in validationResult.Errors)
                        {
                            <li><strong>@error.Path</strong>: @error.Message</li>
                        }
                    </ul>
                </RadzenAlert>
            }
        </RadzenCard>
    }
</RadzenStack>

@code {
    [Parameter] public SchemaResource schema { get; set; } = new();
    private string draftJsonText = "";
    private bool isValidated = false;
    private ValidationResult? validationResult;
    private string ownerId = "DefaultUser";

    protected override void OnInitialized()
    {
        draftJsonText = JsonSerializer.Serialize(schema.DraftJson, new JsonSerializerOptions { WriteIndented = true });
    }

    private async Task SaveDraft()
    {
        try
        {
            schema = await Mediator.Send(new SaveSchemaDraftCommand(ownerId, schema.Id, draftJsonText));
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Success", Detail = "Draft saved successfully" });
            isValidated = false;
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = ex.Message });
        }
    }

    private async Task ValidateDraft()
    {
        try
        {
            validationResult = await Mediator.Send(new ValidateSchemaDraftCommand(draftJsonText));
            isValidated = validationResult.IsValid;
        }
        catch (Exception ex)
        {
            validationResult = new ValidationResult(false, new List<ValidationError> { new ValidationError("$", ex.Message) });
            isValidated = false;
        }
    }

    private async Task PublishDraft()
    {
        try
        {
            await SaveDraft();
            await Mediator.Send(new PublishSchemaCommand(ownerId, schema.Id));
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Published", Detail = "New version published!" });
            NavManager.NavigateTo("/Schemas");
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Error", Detail = ex.Message });
        }
    }
}
