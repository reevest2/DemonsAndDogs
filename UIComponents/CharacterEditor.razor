@using System.Text.Json
@using Models.Resources
@using Radzen
@using Radzen.Blazor

@if (!HasTemplate)
{
    <RadzenCard>
        <RadzenStack Gap="12px">
            <RadzenText TextStyle="TextStyle.H5">Select a Character Template</RadzenText>

            <RadzenFormField Text="Template">
                <RadzenDropDown Style="width: 100%"
                                Data="@Templates"
                                TValue="string"
                                TextProperty="Name"
                                ValueProperty="Id"
                                @bind-Value="SelectedTemplateId"
                                Change="@OnTemplateSelected" />
            </RadzenFormField>

            @if (!string.IsNullOrWhiteSpace(TemplatePreviewName))
            {
                <RadzenText TextStyle="TextStyle.Body1">@TemplatePreviewName</RadzenText>
            }
        </RadzenStack>
    </RadzenCard>
}
else if (ActiveTemplate is null)
{
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.Body1">Loading template…</RadzenText>
    </RadzenCard>
}
else
{
    <RadzenStack Gap="12px">
        <RadzenFieldset Text="Template">
            <RadzenRow Gap="12px">
                <RadzenColumn Size="12" SizeMD="8">
                    <RadzenFormField Text="Template">
                        <RadzenTextBox Style="width: 100%" Value="@ActiveTemplate.Name" Disabled="true" />
                    </RadzenFormField>
                </RadzenColumn>

                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenFormField Text="Version">
                        <RadzenTextBox Style="width: 100%" Value="@Model.TemplateVersion" Disabled="true" />
                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>

            <RadzenButton Text="Change Template" ButtonStyle="ButtonStyle.Light" Click="@ResetTemplate" />
        </RadzenFieldset>

        @foreach (var sec in (ActiveTemplate.Sections ?? new()).OrderBy(x => x.Order))
        {
            <RadzenFieldset Text="@sec.Label">
                <RadzenStack Gap="10px">
                    @foreach (var field in (sec.Fields ?? new()).OrderBy(x => x.Order))
                    {
                        @RenderField(field)
                    }
                </RadzenStack>
            </RadzenFieldset>
        }
    </RadzenStack>
}

@code {
    [Parameter] public CharacterData Model { get; set; }
    [Parameter] public EventCallback<CharacterData> ModelChanged { get; set; }

    [Parameter] public List<TemplateListItem> Templates { get; set; } = new();
    [Parameter] public Func<string, Task<TemplateLoadResult>> LoadTemplate { get; set; }

    CharacterTemplateData ActiveTemplate;

    bool HasTemplate => !string.IsNullOrWhiteSpace(Model?.TemplateResourceId);

    string SelectedTemplateId { get; set; } = "";
    string TemplatePreviewName => Templates?.FirstOrDefault(x => string.Equals(x.Id, SelectedTemplateId, StringComparison.OrdinalIgnoreCase))?.Name ?? "";

    protected override async Task OnParametersSetAsync()
    {
        if (HasTemplate && ActiveTemplate is null && LoadTemplate is not null)
        {
            var loaded = await LoadTemplate(Model.TemplateResourceId);
            ActiveTemplate = loaded.Template;
            Model.TemplateVersion = loaded.Version;
            EnsureValuesForTemplate(Model, ActiveTemplate);
            await ModelChanged.InvokeAsync(Model);
        }
    }

    async Task OnTemplateSelected(object _)
    {
        if (string.IsNullOrWhiteSpace(SelectedTemplateId) || LoadTemplate is null) return;

        var loaded = await LoadTemplate(SelectedTemplateId);

        Model.TemplateResourceId = SelectedTemplateId;
        Model.TemplateVersion = loaded.Version;

        ActiveTemplate = loaded.Template;

        EnsureValuesForTemplate(Model, ActiveTemplate);

        await ModelChanged.InvokeAsync(Model);
    }

    async Task ResetTemplate()
    {
        Model.TemplateResourceId = "";
        Model.TemplateVersion = "0";
        ActiveTemplate = null;
        SelectedTemplateId = "";
        await ModelChanged.InvokeAsync(Model);
    }

    RenderFragment RenderField(CharacterTemplateField field) => builder =>
    {
        var i = 0;

        builder.OpenComponent<RadzenFormField>(i++);
        builder.AddAttribute(i++, "Text", field.Label);

        if (field.Type == CharacterFieldType.Text)
        {
            builder.OpenComponent<RadzenTextBox>(i++);
            builder.AddAttribute(i++, "Style", "width: 100%");
            builder.AddAttribute(i++, "Value", GetString(field.Key));
            builder.AddAttribute(i++, "ValueChanged", EventCallback.Factory.Create<string>(this, v => SetString(field.Key, v)));
            builder.CloseComponent();
        }
        else if (field.Type == CharacterFieldType.MultilineText)
        {
            builder.OpenComponent<RadzenTextArea>(i++);
            builder.AddAttribute(i++, "Style", "width: 100%; min-height: 110px");
            builder.AddAttribute(i++, "Value", GetString(field.Key));
            builder.AddAttribute(i++, "ValueChanged", EventCallback.Factory.Create<string>(this, v => SetString(field.Key, v)));
            builder.CloseComponent();
        }
        else if (field.Type == CharacterFieldType.Number)
        {
            builder.OpenComponent<RadzenNumeric<int>>(i++);
            builder.AddAttribute(i++, "Style", "width: 100%");
            builder.AddAttribute(i++, "Value", GetInt(field.Key));
            builder.AddAttribute(i++, "ValueChanged", EventCallback.Factory.Create<int>(this, v => SetInt(field.Key, v)));
            builder.CloseComponent();
        }
        else if (field.Type == CharacterFieldType.Boolean)
        {
            builder.OpenComponent<RadzenCheckBox<bool>>(i++);
            builder.AddAttribute(i++, "Value", GetBool(field.Key));
            builder.AddAttribute(i++, "ValueChanged", EventCallback.Factory.Create<bool>(this, v => SetBool(field.Key, v)));
            builder.CloseComponent();
        }
        else if (field.Type == CharacterFieldType.Select)
        {
            builder.OpenComponent<RadzenDropDown<string>>(i++);
            builder.AddAttribute(i++, "Style", "width: 100%");
            builder.AddAttribute(i++, "Data", field.Options ?? new List<CharacterTemplateOption>());
            builder.AddAttribute(i++, "TextProperty", "Label");
            builder.AddAttribute(i++, "ValueProperty", "Value");
            builder.AddAttribute(i++, "Value", GetStringOrNull(field.Key));
            builder.AddAttribute(i++, "ValueChanged", EventCallback.Factory.Create<string>(this, v => SetStringOrNull(field.Key, v)));
            builder.CloseComponent();
        }
        else if (field.Type == CharacterFieldType.MultiSelect)
        {
            builder.OpenComponent<RadzenDropDown<IEnumerable<string>>>(i++);
            builder.AddAttribute(i++, "Style", "width: 100%");
            builder.AddAttribute(i++, "Multiple", true);
            builder.AddAttribute(i++, "Data", field.Options ?? new List<CharacterTemplateOption>());
            builder.AddAttribute(i++, "TextProperty", "Label");
            builder.AddAttribute(i++, "ValueProperty", "Value");
            builder.AddAttribute(i++, "Value", GetStringList(field.Key));
            builder.AddAttribute(i++, "ValueChanged", EventCallback.Factory.Create<IEnumerable<string>>(this, v => SetStringList(field.Key, v)));
            builder.CloseComponent();
        }
        else
        {
            builder.OpenComponent<RadzenTextBox>(i++);
            builder.AddAttribute(i++, "Style", "width: 100%");
            builder.AddAttribute(i++, "Value", GetRawJson(field.Key));
            builder.AddAttribute(i++, "ValueChanged", EventCallback.Factory.Create<string>(this, v => SetRawJson(field.Key, v)));
            builder.CloseComponent();
        }

        builder.CloseComponent();
    };

    static void EnsureValuesForTemplate(CharacterData resource, CharacterTemplateData template)
    {
        resource.Values ??= new Dictionary<string, JsonElement>(StringComparer.OrdinalIgnoreCase);

        foreach (var sec in template.Sections ?? new List<CharacterTemplateSection>())
        {
            foreach (var field in sec.Fields ?? new List<CharacterTemplateField>())
            {
                if (!resource.Values.ContainsKey(field.Key))
                {
                    if (field.DefaultValue.HasValue)
                        resource.Values[field.Key] = field.DefaultValue.Value;
                    else
                        resource.Values[field.Key] = EmptyValue(field.Type);
                }
            }
        }
    }

    static JsonElement EmptyValue(CharacterFieldType type)
    {
        var json = type switch
        {
            CharacterFieldType.Text => "\"\"",
            CharacterFieldType.MultilineText => "\"\"",
            CharacterFieldType.Number => "0",
            CharacterFieldType.Boolean => "false",
            CharacterFieldType.Select => "null",
            CharacterFieldType.MultiSelect => "[]",
            _ => "null"
        };

        return JsonDocument.Parse(json).RootElement.Clone();
    }

    string GetString(string key)
    {
        if (Model.Values is null) return "";
        if (!Model.Values.TryGetValue(key, out var el)) return "";
        if (el.ValueKind == JsonValueKind.String) return el.GetString() ?? "";
        return el.ToString() ?? "";
    }

    string GetStringOrNull(string key)
    {
        if (Model.Values is null) return null;
        if (!Model.Values.TryGetValue(key, out var el)) return null;
        if (el.ValueKind == JsonValueKind.Null) return null;
        if (el.ValueKind == JsonValueKind.String) return el.GetString();
        return el.ToString();
    }

    int GetInt(string key)
    {
        if (Model.Values is null) return 0;
        if (!Model.Values.TryGetValue(key, out var el)) return 0;
        if (el.ValueKind == JsonValueKind.Number && el.TryGetInt32(out var n)) return n;
        if (el.ValueKind == JsonValueKind.String && int.TryParse(el.GetString(), out var s)) return s;
        return 0;
    }

    bool GetBool(string key)
    {
        if (Model.Values is null) return false;
        if (!Model.Values.TryGetValue(key, out var el)) return false;
        if (el.ValueKind == JsonValueKind.True) return true;
        if (el.ValueKind == JsonValueKind.False) return false;
        if (el.ValueKind == JsonValueKind.String && bool.TryParse(el.GetString(), out var b)) return b;
        return false;
    }

    IEnumerable<string> GetStringList(string key)
    {
        if (Model.Values is null) return Array.Empty<string>();
        if (!Model.Values.TryGetValue(key, out var el)) return Array.Empty<string>();
        if (el.ValueKind != JsonValueKind.Array) return Array.Empty<string>();

        var list = new List<string>();
        foreach (var item in el.EnumerateArray())
        {
            if (item.ValueKind == JsonValueKind.String) list.Add(item.GetString() ?? "");
            else list.Add(item.ToString() ?? "");
        }
        return list;
    }

    string GetRawJson(string key)
    {
        if (Model.Values is null) return "";
        if (!Model.Values.TryGetValue(key, out var el)) return "";
        return el.GetRawText();
    }

    async Task SetString(string key, string value)
    {
        Model.Values ??= new Dictionary<string, JsonElement>(StringComparer.OrdinalIgnoreCase);
        var json = JsonSerializer.Serialize(value ?? "");
        Model.Values[key] = JsonDocument.Parse(json).RootElement.Clone();
        await ModelChanged.InvokeAsync(Model);
    }

    async Task SetStringOrNull(string key, string value)
    {
        Model.Values ??= new Dictionary<string, JsonElement>(StringComparer.OrdinalIgnoreCase);

        if (string.IsNullOrWhiteSpace(value))
            Model.Values[key] = JsonDocument.Parse("null").RootElement.Clone();
        else
            Model.Values[key] = JsonDocument.Parse(JsonSerializer.Serialize(value)).RootElement.Clone();

        await ModelChanged.InvokeAsync(Model);
    }

    async Task SetInt(string key, int value)
    {
        Model.Values ??= new Dictionary<string, JsonElement>(StringComparer.OrdinalIgnoreCase);
        Model.Values[key] = JsonDocument.Parse(value.ToString()).RootElement.Clone();
        await ModelChanged.InvokeAsync(Model);
    }

    async Task SetBool(string key, bool value)
    {
        Model.Values ??= new Dictionary<string, JsonElement>(StringComparer.OrdinalIgnoreCase);
        Model.Values[key] = JsonDocument.Parse(value ? "true" : "false").RootElement.Clone();
        await ModelChanged.InvokeAsync(Model);
    }

    async Task SetStringList(string key, IEnumerable<string> value)
    {
        Model.Values ??= new Dictionary<string, JsonElement>(StringComparer.OrdinalIgnoreCase);
        var json = JsonSerializer.Serialize(value ?? Array.Empty<string>());
        Model.Values[key] = JsonDocument.Parse(json).RootElement.Clone();
        await ModelChanged.InvokeAsync(Model);
    }

    async Task SetRawJson(string key, string value)
    {
        Model.Values ??= new Dictionary<string, JsonElement>(StringComparer.OrdinalIgnoreCase);

        try
        {
            var doc = JsonDocument.Parse(string.IsNullOrWhiteSpace(value) ? "null" : value);
            Model.Values[key] = doc.RootElement.Clone();
        }
        catch
        {
            Model.Values[key] = JsonDocument.Parse("null").RootElement.Clone();
        }

        await ModelChanged.InvokeAsync(Model);
    }

    public sealed class TemplateListItem
    {
        public string Id { get; set; }
        public string Name { get; set; }
        public int Version { get; set; }
    }

    public sealed class TemplateLoadResult
    {
        public CharacterTemplateData Template { get; set; }
        public string Version { get; set; }
    }
}