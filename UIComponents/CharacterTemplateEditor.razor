@using Models.Character
@using Models.Resources.Character
@using Radzen
@using Radzen.Blazor

<RadzenTemplateForm Data="@Model">
    <RadzenTabs TabRenderMode="TabRenderMode.Client">
        <Tabs>
            <RadzenTabsItem Text="Template">
                <RadzenStack Gap="12px">
                    <RadzenFieldset Text="Basics">
                        <RadzenStack Gap="10px">
                            <RadzenFormField Text="Name">
                                <RadzenTextBox Style="width: 100%" @bind-Value="Model.Name"/>
                            </RadzenFormField>

                            <RadzenFormField Text="Description">
                                <RadzenTextArea Style="width: 100%; min-height: 120px" @bind-Value="Model.Description"/>
                            </RadzenFormField>
                        </RadzenStack>
                    </RadzenFieldset>

                    <RadzenFieldset Text="Thumbnail">
                        <RadzenStack Gap="10px">
                            <RadzenFormField Text="Image Url">
                                <RadzenTextBox Style="width: 100%" @bind-Value="ThumbnailUrl" Change="@(_ => Notify())"/>
                            </RadzenFormField>

                            @if (!string.IsNullOrWhiteSpace(ThumbnailUrl))
                            {
                                <img src="@ThumbnailUrl" style="max-width: 220px; border-radius: 8px;"/>
                            }
                        </RadzenStack>
                    </RadzenFieldset>
                </RadzenStack>
            </RadzenTabsItem>

            <RadzenTabsItem Text="Sections & Fields">
                <RadzenRow Gap="12px">
                    <RadzenColumn Size="12" SizeMD="5">
                        <RadzenCard>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.H6">Sections</RadzenText>
                                <RadzenButton Icon="add" Text="Add" ButtonStyle="ButtonStyle.Primary" Click="@AddSection"/>
                            </RadzenStack>

                            <RadzenDataGrid @ref="sectionsGrid"
                                            Data="@SectionsOrdered"
                                            TItem="CharacterTemplateSection"
                                            AllowPaging="false"
                                            AllowSorting="false"
                                            EditMode="DataGridEditMode.Single"
                                            RowSelect="@OnSectionSelected">
                                <Columns>
                                    <RadzenDataGridColumn TItem="CharacterTemplateSection" Property="Order" Title="#" Width="70px">
                                        <EditTemplate Context="s">
                                            <RadzenNumeric Style="width: 100%" @bind-Value="s.Order"/>
                                        </EditTemplate>
                                    </RadzenDataGridColumn>

                                    <RadzenDataGridColumn TItem="CharacterTemplateSection" Property="Label" Title="Label">
                                        <EditTemplate Context="s">
                                            <RadzenTextBox Style="width: 100%" @bind-Value="s.Label"/>
                                        </EditTemplate>
                                    </RadzenDataGridColumn>

                                    <RadzenDataGridColumn TItem="CharacterTemplateSection" Property="Key" Title="Key" Width="160px">
                                        <EditTemplate Context="s">
                                            <RadzenTextBox Style="width: 100%" @bind-Value="s.Key"/>
                                        </EditTemplate>
                                    </RadzenDataGridColumn>

                                    <RadzenDataGridColumn TItem="CharacterTemplateSection" Title="Actions" Width="170px">
                                        <Template Context="s">
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="6px">
                                                <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(() => EditSection(s))"/>
                                                <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(() => RemoveSection(s))"/>
                                            </RadzenStack>
                                        </Template>
                                        <EditTemplate Context="s">
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="6px">
                                                <RadzenButton Icon="check" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success" Click="@(() => SaveSection(s))"/>
                                                <RadzenButton Icon="close" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@CancelSectionEdit"/>
                                            </RadzenStack>
                                        </EditTemplate>
                                    </RadzenDataGridColumn>
                                </Columns>
                            </RadzenDataGrid>
                        </RadzenCard>
                    </RadzenColumn>

                    <RadzenColumn Size="12" SizeMD="7">
                        <RadzenCard>
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenText TextStyle="TextStyle.H6">Fields</RadzenText>
                                <RadzenButton Icon="add" Text="Add" ButtonStyle="ButtonStyle.Primary" Disabled="@(!HasSelectedSection)" Click="@AddField"/>
                            </RadzenStack>

                            @if (!HasSelectedSection)
                            {
                                <RadzenText TextStyle="TextStyle.Body1">Select a section to edit its fields.</RadzenText>
                            }
                            else
                            {
                                <RadzenDataGrid @ref="fieldsGrid"
                                                Data="@FieldsOrdered"
                                                TItem="CharacterTemplateField"
                                                AllowPaging="false"
                                                AllowSorting="false"
                                                EditMode="DataGridEditMode.Single"
                                                RowSelect="@OnFieldSelected">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="CharacterTemplateField" Property="Order" Title="#" Width="70px">
                                            <EditTemplate Context="f">
                                                <RadzenNumeric Style="width: 100%" @bind-Value="f.Order"/>
                                            </EditTemplate>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="CharacterTemplateField" Property="Label" Title="Label">
                                            <EditTemplate Context="f">
                                                <RadzenTextBox Style="width: 100%" @bind-Value="f.Label"/>
                                            </EditTemplate>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="CharacterTemplateField" Property="Key" Title="Key" Width="160px">
                                            <EditTemplate Context="f">
                                                <RadzenTextBox Style="width: 100%" @bind-Value="f.Key"/>
                                            </EditTemplate>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="CharacterTemplateField" Property="Type" Title="Type" Width="180px">
                                            <EditTemplate Context="f">
                                                <RadzenDropDown Style="width: 100%"
                                                                TValue="CharacterFieldType"
                                                                Data="@FieldTypes"
                                                                @bind-Value="f.Type"/>
                                            </EditTemplate>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="CharacterTemplateField" Property="Required" Title="Required" Width="110px">
                                            <Template Context="f">
                                                <RadzenCheckBox TValue="bool" Value="@f.Required" Disabled="true"/>
                                            </Template>
                                            <EditTemplate Context="f">
                                                <RadzenCheckBox TValue="bool" @bind-Value="f.Required"/>
                                            </EditTemplate>
                                        </RadzenDataGridColumn>

                                        <RadzenDataGridColumn TItem="CharacterTemplateField" Title="Actions" Width="170px">
                                            <Template Context="f">
                                                <RadzenStack Orientation="Orientation.Horizontal" Gap="6px">
                                                    <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(() => EditField(f))"/>
                                                    <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(() => RemoveField(f))"/>
                                                </RadzenStack>
                                            </Template>
                                            <EditTemplate Context="f">
                                                <RadzenStack Orientation="Orientation.Horizontal" Gap="6px">
                                                    <RadzenButton Icon="check" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success" Click="@(() => SaveField(f))"/>
                                                    <RadzenButton Icon="close" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@CancelFieldEdit"/>
                                                </RadzenStack>
                                            </EditTemplate>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>

                                <hr/>

                                <RadzenFieldset Text="Field Details" Expanded="true">
                                    @if (SelectedField is null)
                                    {
                                        <RadzenText TextStyle="TextStyle.Body1">Select a field to edit advanced settings.</RadzenText>
                                    }
                                    else
                                    {
                                        <RadzenStack Gap="10px">
                                            <RadzenRow Gap="12px">
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Min">
                                                        <RadzenNumeric Style="width: 100%" @bind-Value="SelectedField.Min"/>
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Max">
                                                        <RadzenNumeric Style="width: 100%" @bind-Value="SelectedField.Max"/>
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Max Length">
                                                        <RadzenNumeric Style="width: 100%" @bind-Value="SelectedField.MaxLength"/>
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                            </RadzenRow>

                                            @if (SelectedField.Type is CharacterFieldType.Select or CharacterFieldType.MultiSelect)
                                            {
                                                <RadzenFieldset Text="Options" Expanded="true">
                                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                        <RadzenText TextStyle="TextStyle.Subtitle2">Values</RadzenText>
                                                        <RadzenButton Icon="add" Text="Add" Size="ButtonSize.Small" Click="@AddOption"/>
                                                    </RadzenStack>

                                                    <RadzenDataGrid Data="@SelectedField.Options"
                                                                    TItem="CharacterTemplateOption"
                                                                    AllowPaging="false"
                                                                    AllowSorting="false"
                                                                    EditMode="DataGridEditMode.Single"
                                                                    @ref="optionsGrid">
                                                        <Columns>
                                                            <RadzenDataGridColumn TItem="CharacterTemplateOption" Property="Label" Title="Label">
                                                                <EditTemplate Context="o">
                                                                    <RadzenTextBox Style="width: 100%" @bind-Value="o.Label"/>
                                                                </EditTemplate>
                                                            </RadzenDataGridColumn>
                                                            <RadzenDataGridColumn TItem="CharacterTemplateOption" Property="Value" Title="Value">
                                                                <EditTemplate Context="o">
                                                                    <RadzenTextBox Style="width: 100%" @bind-Value="o.Value"/>
                                                                </EditTemplate>
                                                            </RadzenDataGridColumn>
                                                            <RadzenDataGridColumn TItem="CharacterTemplateOption" Title="Actions" Width="130px">
                                                                <Template Context="o">
                                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="6px">
                                                                        <RadzenButton Icon="edit" Size="ButtonSize.Small" Click="@(() => EditOption(o))"/>
                                                                        <RadzenButton Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Click="@(() => RemoveOption(o))"/>
                                                                    </RadzenStack>
                                                                </Template>
                                                                <EditTemplate Context="o">
                                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="6px">
                                                                        <RadzenButton Icon="check" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success" Click="@(() => SaveOption(o))"/>
                                                                        <RadzenButton Icon="close" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Light" Click="@CancelOptionEdit"/>
                                                                    </RadzenStack>
                                                                </EditTemplate>
                                                            </RadzenDataGridColumn>
                                                        </Columns>
                                                    </RadzenDataGrid>
                                                </RadzenFieldset>
                                            }
                                        </RadzenStack>
                                    }
                                </RadzenFieldset>
                            }
                        </RadzenCard>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
    <RadzenButton Text="Save" ButtonType="ButtonType.Submit" Click="Save"></RadzenButton>
    
</RadzenTemplateForm>

@code {
    [Parameter] public CharacterTemplateData Model { get; set; }
    [Parameter] public EventCallback<object> OnSave { get; set; }
    [Parameter] public EventCallback<CharacterTemplateData> ModelChanged { get; set; }

    RadzenDataGrid<CharacterTemplateSection> sectionsGrid;
    RadzenDataGrid<CharacterTemplateField> fieldsGrid;
    RadzenDataGrid<CharacterTemplateOption> optionsGrid;

    CharacterTemplateSection SelectedSection;
    CharacterTemplateField SelectedField;

    string ThumbnailUrl
    {
        get => Model?.Thumbnail?.ImageUrl ?? "";
        set
        {
            Model.Thumbnail ??= new ThumbnailMetadata();
            Model.Thumbnail.ImageUrl = value ?? "";
        }
    }

    bool HasSelectedSection => SelectedSection is not null;

    IEnumerable<CharacterFieldType> FieldTypes => Enum.GetValues<CharacterFieldType>();

    List<CharacterTemplateSection> SectionsOrdered =>
        (Model.Sections ??= new List<CharacterTemplateSection>())
        .OrderBy(x => x.Order)
        .ToList();

    List<CharacterTemplateField> FieldsOrdered =>
        (SelectedSection.Fields ??= new List<CharacterTemplateField>())
        .OrderBy(x => x.Order)
        .ToList();

    Task Notify() => ModelChanged.InvokeAsync(Model);

    async Task AddSection()
    {
        Model.Sections ??= new List<CharacterTemplateSection>();

        var s = new CharacterTemplateSection
        {
            Key = NewKey(Model.Sections.Select(x => x.Key), "section"),
            Label = "New Section",
            Order = NextOrder(Model.Sections.Select(x => x.Order)),
            Fields = new List<CharacterTemplateField>()
        };

        Model.Sections.Add(s);
        SelectedSection = s;
        SelectedField = null;

        await Notify();

        if (sectionsGrid is not null)
            await sectionsGrid.EditRow(s);
    }

    async Task EditSection(CharacterTemplateSection s)
    {
        SelectedSection = s;
        SelectedField = null;

        if (sectionsGrid is not null)
            await sectionsGrid.EditRow(s);
    }

    async Task SaveSection(CharacterTemplateSection s)
    {
        NormalizeSection(s);
        await Notify();

        if (sectionsGrid is not null)
            await sectionsGrid.UpdateRow(s);
    }

    async Task CancelSectionEdit()
    {
        if (sectionsGrid is not null && SelectedSection is not null)
             sectionsGrid.CancelEditRow(SelectedSection);
    }

    async Task RemoveSection(CharacterTemplateSection s)
    {
        if (Model.Sections is null) return;

        Model.Sections.Remove(s);

        if (ReferenceEquals(SelectedSection, s))
        {
            SelectedSection = null;
            SelectedField = null;
        }

        await Notify();
    }

    Task OnSectionSelected(CharacterTemplateSection s)
    {
        SelectedSection = s;
        SelectedField = null;
        return Notify();
    }

    async Task AddField()
    {
        if (SelectedSection is null) return;

        SelectedSection.Fields ??= new List<CharacterTemplateField>();

        var f = new CharacterTemplateField
        {
            Key = NewKey(SelectedSection.Fields.Select(x => x.Key), "field"),
            Label = "New Field",
            Type = CharacterFieldType.Text,
            Required = false,
            Order = NextOrder(SelectedSection.Fields.Select(x => x.Order)),
            Options = new List<CharacterTemplateOption>()
        };

        SelectedSection.Fields.Add(f);
        SelectedField = f;

        await Notify();

        if (fieldsGrid is not null)
            await fieldsGrid.EditRow(f);
    }

    async Task EditField(CharacterTemplateField f)
    {
        SelectedField = f;

        if (fieldsGrid is not null)
            await fieldsGrid.EditRow(f);
    }

    async Task SaveField(CharacterTemplateField f)
    {
        NormalizeField(f);
        await Notify();

        if (fieldsGrid is not null)
            await fieldsGrid.UpdateRow(f);
    }

    async Task CancelFieldEdit()
    {
        if (fieldsGrid is not null && SelectedField is not null)
             fieldsGrid.CancelEditRow(SelectedField);
    }

    async Task RemoveField(CharacterTemplateField f)
    {
        if (SelectedSection?.Fields is null) return;

        SelectedSection.Fields.Remove(f);

        if (ReferenceEquals(SelectedField, f))
            SelectedField = null;

        await Notify();
    }

    Task OnFieldSelected(CharacterTemplateField f)
    {
        SelectedField = f;
        return Notify();
    }

    async Task AddOption()
    {
        if (SelectedField is null) return;

        SelectedField.Options ??= new List<CharacterTemplateOption>();

        var o = new CharacterTemplateOption
        {
            Label = "New Option",
            Value = NewKey(SelectedField.Options.Select(x => x.Value), "option")
        };

        SelectedField.Options.Add(o);

        await Notify();

        if (optionsGrid is not null)
            await optionsGrid.EditRow(o);
    }

    async Task EditOption(CharacterTemplateOption o)
    {
        if (optionsGrid is not null)
            await optionsGrid.EditRow(o);
    }

    async Task SaveOption(CharacterTemplateOption o)
    {
        o.Label = (o.Label ?? "").Trim();
        o.Value = (o.Value ?? "").Trim();

        await Notify();

        if (optionsGrid is not null)
            await optionsGrid.UpdateRow(o);
    }

    async Task CancelOptionEdit()
    {
        if (optionsGrid is not null)
             optionsGrid.CancelEditRow(null);
    }

    async Task RemoveOption(CharacterTemplateOption o)
    {
        if (SelectedField?.Options is null) return;

        SelectedField.Options.Remove(o);
        await Notify();
    }

    static int NextOrder(IEnumerable<int> orders)
    {
        var list = orders?.ToList() ?? new List<int>();
        return list.Count == 0 ? 1 : list.Max() + 1;
    }

    static string NewKey(IEnumerable<string> existing, string prefix)
    {
        var set = new HashSet<string>((existing ?? Array.Empty<string>())
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .Select(x => x.Trim()), StringComparer.OrdinalIgnoreCase);

        var i = 1;
        while (true)
        {
            var key = $"{prefix}{i}";
            if (!set.Contains(key)) return key;
            i++;
        }
    }

    static void NormalizeSection(CharacterTemplateSection s)
    {
        s.Key = (s.Key ?? "").Trim();
        s.Label = (s.Label ?? "").Trim();
        s.Fields ??= new List<CharacterTemplateField>();
    }

    static void NormalizeField(CharacterTemplateField f)
    {
        f.Key = (f.Key ?? "").Trim();
        f.Label = (f.Label ?? "").Trim();
        f.Options ??= new List<CharacterTemplateOption>();

        if (f.Type is not CharacterFieldType.Select and not CharacterFieldType.MultiSelect)
            f.Options.Clear();
    }
    async Task Save()
    {
        if (OnSave.HasDelegate)
            await OnSave.InvokeAsync(Model);
    }
}