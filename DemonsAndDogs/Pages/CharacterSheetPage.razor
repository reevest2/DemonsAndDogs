@page "/characterSheet/{ResourceId?}"
@inject IMediator Mediator
@inject NavigationManager NavigationManager
@using API.Services.Abstraction
@using DemonsAndDogs.Mediator.Records
@using MediatR
@using Models.Character
@using UIComponents.CharacterSheet

<h3>Character Sheet</h3>

@* Use the CharacterSheetEditor from the Razor class library. Import its namespace via the @using directive below. *@

<EditForm Model="model" OnValidSubmit="Save">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <CharacterSheetEditor Model="model" />
    <button type="submit" class="btn btn-success mt-3">Save</button>
</EditForm>

@code {
    [Parameter] public string ResourceId { get; set; }
    
    private CharacterResource model = new CharacterResource
    {
        Thumbnail = new ThumbnailMetadata(),
        CharacterSheet = new CharacterSheet()
    };

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrWhiteSpace(ResourceId))
        {
            var resource = await Mediator.Send(new GetCharacterResourcesQuery());
            if (resource != null)
            {
                model = resource.First();
            }
        }
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(ResourceId))
        {
            var created = await Mediator.Send(new CreateCharacterResourceCommand(model));
        }
        else
        {
            await Mediator.Send(new UpdateCharacterResourceCommand(ResourceId,model));
        }
        NavigationManager.NavigateTo("/characterSheets");
    }
}