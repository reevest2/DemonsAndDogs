@using MediatR
@using Models.Contracts
@using Models.DTO
@using UIComponents.PageComponents

<ResourceManagementPage ResourceName="@resourceName" OnSave="@Save" Items="@Items" />

@code {
    [Parameter] public string resourceName { get; set; } = "";
    [Parameter] public string ownerId { get; set; } = "";
    [Inject] IMediator Mediator { get; set; } = default!;

    private IReadOnlyList<ResourceDto> Items { get; set; } = Array.Empty<ResourceDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadItems();
    }

    private async Task Save(object model)
    {
        if (model is not CreateResourceRequest m) return;

        await Mediator.Send(new CreateResourceCommand(
            resourceName,
            m.ResourceName,
            m.ResourceDescription,
            m.EntityId,
            ownerId,
            m.SubjectId,
            m.Data
        ));

        await LoadItems();
        StateHasChanged();
    }

    private async Task LoadItems()
    {
        var page = await Mediator.Send(new ListResourcesQuery(
            resourceName,
            0,
            50,
            null,
            null,
            false,
            ownerId
        ));

        Items = page.Items;
    }
}